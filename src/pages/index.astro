---
import fs from 'fs';
import path from 'path';
import ThemeScript from '../components/ThemeScript.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import '../styles/global.css';

const galleriesDir = path.resolve('src/images');
let galleries = [];

if (fs.existsSync(galleriesDir)) {
  const folders = fs.readdirSync(galleriesDir).filter((f) => {
    const fullPath = path.join(galleriesDir, f);
    return fs.statSync(fullPath).isDirectory();
  });

  galleries = folders.map((slug) => {
    const metaPath = path.join(galleriesDir, slug, 'meta.json');
    let metadata = { title: slug.replace(/-/g, ' ') };
    if (fs.existsSync(metaPath)) {
      const meta = JSON.parse(fs.readFileSync(metaPath, 'utf-8'));
      metadata = { ...metadata, ...meta };
    }

    const publicDir = path.join('public/photos', slug);
    let coverImage = null;
    let imageCount = 0;
    
    if (fs.existsSync(publicDir)) {
      // Count unique images (base names, ignoring sizes/formats)
      const files = fs.readdirSync(publicDir).filter(f => f.match(/\.(jpg|webp|avif)$/));
      const baseNames = new Set(files.map(f => f.replace(/-\d+\.(jpg|webp|avif)$/, '')));
      imageCount = baseNames.size;
      
      if (metadata.cover) {
        const base = metadata.cover;
        const possibleFormats = ['avif', 'webp', 'jpg'];
        const possibleSizes = ['1600', '600']; 
        
        for (const size of possibleSizes) {
          for (const ext of possibleFormats) {
            const candidate = path.join(publicDir, `${base}-${size}.${ext}`);
            if (fs.existsSync(candidate)) {
              coverImage = `/photos/${slug}/${base}-${size}.${ext}`;
              break;
            }
          }
          if (coverImage) break;
        }
      }
      if (!coverImage) {
        coverImage = files[0] ? `/photos/${slug}/${files[0]}` : null;
      }
    }

    return { slug, ...metadata, imageCount, coverImage };
  });
}
---

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <ThemeScript />
    <script async src="https://plausible.io/js/pa-QYxd5Cj6D5P36ZkyJqw1s.js"></script>
    <script>
    window.plausible = window.plausible || function() {
        (plausible.q = plausible.q || []).push(arguments) }, plausible.init = plausible.init || function(i) { plausible.o = i || {} };
    plausible.init()
    </script>
    <title>Kwon.photos</title>
    <style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 3rem 2rem;
    }

    header {
        margin: 0 auto;
        color: var(--text-muted);
        font-size: 0.85em;
    }

    main {
        flex: 1;
        margin: 0 auto;
        padding: 10rem;
        font-size: 1em;
    }

    h1 {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: var(--text-secondary);
        font-weight: 90;
    }

    a {
        color: var(--text-secondary);
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }

    p.intro {
        font-size: 0.8rem;
        line-height: 1.6;
        color: var(--text-secondary);
        max-width: 100ch;
        margin-bottom: 3rem;
    }

    .galleries {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        width: 100%;
    }

    .gallery {
        width: 40%;
    }

    .thumb {
        display: block;
        aspect-ratio: 4/3;
        background: var(--thumb-bg);
        border-radius: 0.5rem;
        overflow: hidden;
        transition: transform 0.2s;
    }

    .thumb:hover {
        transform: scale(1.02);
    }

    .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .title {
        margin-top: 0.75rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .title a {
        color: var(--text-secondary);
        text-decoration: none;
    }

    footer {
        font-size: 0.75rem;
        color: var(--text-secondary);
        padding: 2rem;
        line-height: 1.5;
    }

    footer a {
        color: inherit;
        text-decoration: none;
    }

    footer a:hover {
        text-decoration: underline !important;
    }

    @media (max-width: 768px) {
        main {
            padding: 1.5rem;
        }

        .galleries {
            flex-direction: column;
            gap: 1.5rem;
        }

        .gallery {
            width: 100%;
        }
    }
    </style>
</head>

<body>
    <div class="container">
    <header>
        <span>Kwon.photos</span>
    </header>
    <main>
        <div class="galleries">
            {galleries.map((g) => (
            <div class="gallery">
                <a class="thumb" href={`/${g.slug}`}> {g.coverImage && <img src={g.coverImage} alt={g.title} />}
                </a>
                <div class="title"><a href={`/${g.slug}`}>{g.title} </a></div> <p class="intro">{g.subtitle || `${g.imageCount} ${g.imageCount === 1 ? 'photo' : 'photos'}`}</p></div> ))} </div> 
    </main>
    <footer>
        <div>This is <a href="/">Kwon.photos</a>, made by me (<a href="https://kwon.nyc/">Rachel</a>)</div>
        <div><a href="https://github.com/rjkwon/photos">Source code</a></div>
        <div>Â© 2025 <a href="https://kwon.nyc/">Kwon.nyc</a></div>
        <div>
            <ThemeToggle />
        </div>
    </footer>
</div>
</body>

</html>